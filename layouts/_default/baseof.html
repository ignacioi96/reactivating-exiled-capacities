<!DOCTYPE html>
<html lang="{{ .Site.LanguageCode | default "en" }}">
<head>
    {{ partial "head.html" . }}
</head>
<body>
    <!-- Show floating navigation on non-home pages -->
    {{ if not .IsHome }}
        {{ partial "header.html" . }}
    {{ end }}
    
    <!-- Main content block -->
    {{ block "main" . }}{{ end }}
    
    <!-- Background image and overlay for all pages -->
    {{ $backgroundImage := .Site.Params.backgroundImage | default "/images/soil-background.jpg" | relURL }}
    <div class="background-container" style="--bg-image: url('{{ $backgroundImage }}');">
        <div class="background-overlay"></div>
    </div>
    
    <!-- Scripts at end of body -->
    {{ block "scripts" . }}{{ end }}
    
    <!-- Only load background mycelium on content pages -->
    {{ if not (or (.IsHome) (eq .Layout "splash")) }}
        {{ $bgMyceliumJS := resources.Get "js/background-mycelium.js" }}
        {{ if $bgMyceliumJS }}
            <script src="{{ $bgMyceliumJS.Permalink }}" defer></script>
        {{ end }}
    {{ end }}
    
    <!-- Only load 3D scripts on home page -->
    {{ if .IsHome }}
        <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
        {{ $mycelium := resources.Get "js/mycelium.js" }}
        {{ if $mycelium }}
            {{ $myceliumMinified := $mycelium | resources.Minify }}
            <script src="{{ $myceliumMinified.Permalink }}"></script>
        {{ end }}
        {{ $network := resources.Get "js/network.js" }}
        {{ if $network }}
            {{ $networkMinified := $network | resources.Minify }}
            <script src="{{ $networkMinified.Permalink }}"></script>
        {{ end }}
    {{ end }}
    
    <!-- Netlify Identity redirect handling -->
    <script>
      if (window.netlifyIdentity) {
        window.netlifyIdentity.on("init", user => {
          if (!user) {
            window.netlifyIdentity.on("login", () => {
              document.location.href = "/admin/";
            });
          }
        });
      }
    </script>
</body>
</html>