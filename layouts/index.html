{{ define "main" }}
{{ $backgroundImage := .Site.Params.backgroundImage | default "/images/soil-background.jpg" | relURL }}
<div class="splash-layout" id="mainLayout" style="--bg-image: url('{{ $backgroundImage }}');">
    <!-- Background image -->
    <div class="background-container">
        <div class="background-overlay"></div>
    </div>

    <!-- Network SVG container (created dynamically by JavaScript) -->

    <!-- Central Content -->
    <div class="content-container">
        <button class="central-button" id="centralButton" onclick="handleButtonClick();">
            {{ .Site.Title | default "reactivating exiled capacities" }}
        </button>
    </div>

    <!-- Navigation Buttons (hidden initially, positioned with fixed coordinates) -->
    <div class="nav-buttons-container" id="navButtonsContainer">
        <!-- About the Inquiry - Top Center -->
        <button class="nav-button nav-button-about" id="aboutButton" onclick="navigateToPage('/about/')">
            about the inquiry
        </button>

        <!-- Mapping Exiled Capacities - Bottom Left -->
        <button class="nav-button nav-button-mapping" id="mappingButton" onclick="navigateToPage('/mapping-capacities/')">
            mapping exiled capacities
        </button>

        <!-- The Nervous System as Relational Fabric - Bottom Right -->
        <button class="nav-button nav-button-nervous" id="nervousButton" onclick="navigateToPage('/nervous-system/')">
            the nervous system as relational fabric
        </button>
    </div>

    <!-- Artist Residency Link (hidden initially) -->
    <div class="artist-residency-link" id="artistResidencyLink" onclick="navigateToPage('/residency/')">
        artist residency 2024
    </div>

    <!-- Instructions -->
    <div class="instructions" id="instructions">
        Click to enter.
        Webpage still undergoing growth.
    </div>

    <!-- Loading indicator -->
    <div class="loading" id="loading">Growing network...</div>
</div>

<script>
// Page state management
let isHomeMode = false;
let transformationInProgress = false;
let hasBeenTransformed = false;

function handleButtonClick() {
    console.log('Button clicked, isHomeMode:', isHomeMode, 'transformationInProgress:', transformationInProgress);
    
    if (transformationInProgress) {
        console.log('Transformation already in progress, ignoring click');
        return;
    }
    
    if (!isHomeMode && !hasBeenTransformed) {
        console.log('Transforming via button click');
        transformToHomeMode();
    } else if (isHomeMode) {
        // In home mode, regenerate network with dynamic targeting
        console.log('Regenerating network to buttons');
        if (typeof growNetworkToButtons === 'function') {
            growNetworkToButtons(); // Now async, handles its own timing
        }
    }
}

async function transformToHomeMode() {
    if (transformationInProgress || hasBeenTransformed) return;
    
    console.log('Starting transformation to home mode...');
    transformationInProgress = true;
    isHomeMode = true;
    hasBeenTransformed = true;
    window.isHomeMode = true;
    
    // Update layout class
    const layout = document.getElementById('mainLayout');
    layout.classList.remove('splash-layout');
    layout.classList.add('home-layout');
    
    // Hide instructions immediately
    const instructions = document.getElementById('instructions');
    if (instructions) {
        instructions.style.transition = 'opacity 0.3s ease';
        instructions.style.opacity = '0';
        instructions.style.pointerEvents = 'none';
    }
    
    // Position buttons invisibly first for measurement
    positionButtonsForMeasurement();
    
    // Start dynamic network growth - it will handle timing internally
    setTimeout(async () => {
        console.log('Starting dynamic network growth...');
        if (typeof growNetworkToButtons === 'function') {
            try {
                await growNetworkToButtons();
            } catch (error) {
                console.error('Error in network growth:', error);
            }
        }
    }, 100);
    
    // Show navigation buttons with staggered timing
    setTimeout(() => {
        showNavigationElements();
    }, 600); // Start buttons slightly before network completes
    
    // Mark transformation complete
    setTimeout(() => {
        transformationInProgress = false;
    }, 2000);
}

function positionButtonsForMeasurement() {
    console.log('Positioning buttons for measurement...');
    
    const navContainer = document.getElementById('navButtonsContainer');
    if (navContainer) {
        navContainer.style.display = 'block';
        navContainer.style.pointerEvents = 'none'; // Keep non-interactive during measurement
        
        // Position buttons invisibly at their final locations
        const buttons = ['aboutButton', 'mappingButton', 'nervousButton'];
        buttons.forEach(buttonId => {
            const button = document.getElementById(buttonId);
            if (button) {
                button.style.opacity = '0';
                button.style.transform = button.style.transform || 'scale(0.8)';
                button.style.visibility = 'visible';
                button.style.pointerEvents = 'none';
            }
        });
    }
}

function showNavigationElements() {
    console.log('Animating navigation elements into view...');
    
    const navContainer = document.getElementById('navButtonsContainer');
    const artistLink = document.getElementById('artistResidencyLink');
    
    if (navContainer) {
        navContainer.style.pointerEvents = 'auto';
        
        // Get individual buttons
        const aboutButton = document.getElementById('aboutButton');
        const mappingButton = document.getElementById('mappingButton');
        const nervousButton = document.getElementById('nervousButton');
        
        // Animate buttons in with staggered timing
        const buttons = [aboutButton, mappingButton, nervousButton];
        const delays = [0, 200, 400]; // Staggered delays
        
        buttons.forEach((button, index) => {
            if (button) {
                // Set transition for smooth animation
                button.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
                
                setTimeout(() => {
                    button.style.opacity = '1';
                    // Remove any translateY offset while preserving other transforms
                    const currentTransform = button.style.transform || '';
                    const newTransform = currentTransform.replace(/translateY\([^)]*\)/g, '').trim();
                    button.style.transform = newTransform || 'scale(1)';
                    button.style.pointerEvents = 'auto';
                    console.log(`Button ${index + 1} animated in`);
                }, delays[index]);
            }
        });
    }
    
    if (artistLink) {
        artistLink.style.display = 'block';
        artistLink.style.opacity = '0';
        artistLink.style.transform = 'translateY(20px)';
        artistLink.style.transition = 'all 0.5s ease';
        artistLink.style.pointerEvents = 'none';
        
        setTimeout(() => {
            artistLink.style.opacity = '1';
            artistLink.style.transform = 'translateY(0)';
            artistLink.style.pointerEvents = 'auto';
        }, 600);
    }
}

function navigateToPage(url) {
    console.log('Navigating to:', url);
    document.body.style.transition = 'opacity 0.3s ease';
    document.body.style.opacity = '0';
    
    setTimeout(() => {
        window.location.href = url;
    }, 200);
}

// Prevent double-transformation on accidental clicks
window.addEventListener('click', function(e) {
    if (e.target === document.getElementById('centralButton')) {
        e.stopPropagation();
    }
});

// Debug function to inspect button positions
window.debugButtonPositions = function() {
    if (window.buttonPositionDebug) {
        console.table(window.buttonPositionDebug.positions);
        return window.buttonPositionDebug;
    } else {
        console.log('No position debug data available yet. Try after network has grown.');
    }
};
</script>
{{ end }}

{{ define "scripts" }}
<!-- Dynamic Network System with Position Detection -->
{{ $js := resources.Get "js/network.js" }}
<script src="{{ $js.Permalink }}"></script>
{{ end }}